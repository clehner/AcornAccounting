{% extends 'site.html' %}

{% load accounting_filters %}


{% block title %}Reconcile {{ account }}{% endblock %}


{% block page_header %}
  <h1>Reconcile {{ account }}</h1>
{% endblock %}


{% block content %}

<!-- Statement Form -->
<form action="." method="POST" id="reconcile_form">
{% csrf_token %}

<div class="form-horizontal">
  {% for field in account_form %}
    <div class ="form-group{% if field.errors %} has-error{% endif %}">
      <label for="{{ field.id_for_label }}" class="control-label col-sm-2">{{ field.label }}:</label>
      <div class="col-sm-3 controls">
        {{ field }}
      </div>
      {% if field.errors %}
        {% for error in field.errors %}
          <p id="error_{{ forloop.counter }}_{{ field.auto_id }}" class="help-block"><strong>{{ error }}</strong></p>
        {% endfor %}
      {% endif %}
    </div>
  {% endfor %}
  <div class ="form-group">
    <label for="last-reconciled" class="control-label col-sm-2">Last Reconciled:</label>
    <div class="col-sm-3">
      <p id="last-reconciled" class="form-control-static">{{ last_reconciled|date:"m/d/Y"|default:"Never" }}</p>
    </div>
  </div>
  <div class ="form-group">
    <label for="reconciled-balance" class="control-label col-sm-2">Reconciled Balance:</label>
    <div class="col-sm-3">
      <p id="reconciled-balance" class="form-control-static">{{ reconciled_balance|currency }}</p>
    </div>
  </div>
  <div class ="form-group">
    <div class="col-sm-2 col-sm-offset-2">
      <button type="submit" name="submit" value="Get Transactions" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-list"></span> Get Transactions</button>
    </div>
  </div>
</div>

<!-- Transaction Formset -->
{% if transaction_formset %}
  {{ transaction_formset.management_form }}

  <!-- Error Alert -->
  {% if transaction_formset.non_form_errors %}
    <br />
    <div class="alert alert-danger">
      <span class="glyphicon glyphicon-minus-sign"></span><strong> Error!</strong> Please correct the following issues before continuing:
      <ul>
        {% for error in transaction_formset.non_form_errors %}
            <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <table class="table table-condensed table-hover">
    <thead>
      <tr>
        <th><input type="checkbox" class="checkall"  name="checkall"/></th>
        <th>Date</th>
        <th>Number</th>
        <th>Memo</th>
        <th class="text-right">Debit</th>
        <th class="text-right">Credit</th>
        <th class="text-right">Event</th>
      </tr>
    </thead>
    <tbody>
      {% for form in transaction_formset %}
        <tr class="{% cycle 'main' 'alt' %}">
          {% for hidden in form.hidden_fields %}
            {{ hidden }}
          {% endfor %}
          <td>{{ form.visible_fields.0.errors.as_ul }}{{ form.visible_fields.0 }}</td>
          <td>{{ form.instance.date|date:"m/d/y" }}</td>
          <td>{{ form.instance.get_entry_number }}</td>
          <td>{{ form.instance.get_memo }}</td>
          {% if form.instance.balance_delta < 0 %}
            <td class="text-right debit">{{ form.instance.balance_delta|currency }}</td>
            <td class="text-right credit"></td>
          {% else %}
            <td class="text-right debit"></td>
            <td class="text-right credit">{{ form.instance.balance_delta|currency }}</td>
          {% endif %}
          <td class="text-right">{{ form.instance.event|default_if_none:"" }}</td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr><td colspan="7">&nbsp;</td></tr>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td class="text-right"><strong>Total:</strong></td>
        <td id="debit_total" class="text-right"></td>
        <td id="credit_total" class="text-right"></td>
        <td></td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td class="text-right"><strong>Net Change:</strong></td>
        <td id="net_change" class="text-right">$0.00</td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td class="text-right"><strong>Out of Balance:</strong></td>
        <td id="out_of_balance" class="text-right">$0.00</td>
        <td></td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  <div class="form-group">
    <button type="submit" name="submit" value="Reconcile Transactions" class="btn btn-primary btn-sm col-sm-offset-2"><span class="glyphicon glyphicon-book"></span> Reconcile Transactions</button>
  </div>
  {% endif %}
</form><br /><br />

{% endblock %}


{% block javascript %}
<script type="text/javascript" src="{{ STATIC_URL }}js/parsley.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/parsley.extend.js"></script>
<script type="text/javascript">
    $(document).ready( function () {
        $('#reconcile_form').parsley({
            successClass: 'has-success',
            errorClass: 'has-error',
            errors: {
                classHandler: function (el) {
                    return $(el).closest('.form-group');
                },
                errorsWrapper: '<ul></ul>',
                errorElem: '<li></li>'
            }
        });
    });
</script>

{% if transaction_formset %}
  <script type="text/javascript">
      /* Recalculate credit/debit totals and net change on checkbox change */
      $(document).ready( function() {
        // Counters and Click-All Checkbox
        $('#reconcile_form input:checkbox').change(function() {recalcCounters()});
        $('#id_account-statement_balance').keyup(function() {recalcCounters()});
        recalcCounters();
        $('.checkall').change(function () {
          $(this).closest('table').find(':checkbox').prop('checked', this.checked);
          recalcCounters();
        });
      });
      var recalcCounters = function () {
          // Calculate and set the Credit Total
          var credit_sum = 0;
          $(".credit").each( function(){
              if($(this).closest('tr').find('input:checkbox').is(':checked') == true) {
                  var trimmed = $(this).html().replace('$', '').replace(',', '');
                  if(!isNaN(trimmed) && trimmed.length != 0) {
                      credit_sum += parseFloat(trimmed);
                  }
              }
          });
          if (isNaN(credit_sum)) {credit_sum = 0}
          $('#credit_total').text('$' + credit_sum.toFixed(2));

          // Calculate and set the Debit Total
          var debit_sum = 0;
          $(".debit").each( function(){
              if( $(this).closest('tr').find('input:checkbox').is(':checked') == true) {
                  var trimmed = $(this).html().replace('($', '').replace(')', '').replace(',', '');
                  if(!isNaN(trimmed) && trimmed.length != 0) {
                      debit_sum += parseFloat(trimmed);
                  }
              }
          });
          $('#debit_total').text('($' + debit_sum.toFixed(2) + ')');

          // Calculate and set the Net Change
          var net_change = credit_sum - debit_sum;
          if(net_change < 0) {
              $('#net_change').text('($' + (debit_sum - credit_sum).toFixed(2) + ')');
          } else if (net_change > 0) {
              $('#net_change').text('$' + (credit_sum - debit_sum).toFixed(2));
          } else {
              $('#net_change').text('$0.00');
          }

          // Calculate and set the Out of Balance amount
          var statement_balance = $('#id_account-statement_balance').val();
          if (isNaN(statement_balance)) {
              statement_balance = 0;
          }
          if ( {{ account.flip_balance|lower }} ) {
              statement_balance = -1 * parseFloat(statement_balance);
          }

          var reconciled_balance = {{ reconciled_balance }};

          if(net_change > (reconciled_balance - statement_balance)) {
              $('#out_of_balance').text('($' + (reconciled_balance + net_change - statement_balance).toFixed(2) + ')');
          } else if ((reconciled_balance - statement_balance) > net_change) {
              $('#out_of_balance').text('$' + (reconciled_balance + statement_balance - net_change).toFixed(2));
          } else {
              $('#out_of_balance').text('$0.00');
          }
      }
  </script>
{% endif %}

{% endblock %}
